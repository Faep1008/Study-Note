# 关于Redis缓存穿透、缓存雪崩和缓存击穿

## 缓存穿透
### 概念
缓存穿透，是指查询一个数据库不存在的数据。正常的使用缓存流程大致是，先进行缓存查询数据，如果key不存在或者key已经过期，再对数据库进行查询，并把查询到的对象放进缓存。如果数据库查询对象为空，则不放进缓存。

### 存在的问题
如果每次查询一个不存在的数据就会每次都去查询数据库，而每次查询都是空，每次又都不会进行缓存。假如有恶意攻击，就可以利用这个漏洞，对数据库造成压力，甚至压垮数据库。

### 解决办法
- 1、最好对于每一个缓存key都有一定的规范约束，这样在程序中对不符合parttern的key 的请求可以拒绝。
- 2、将可能出现的缓存key的组合方式的所有数值以hash形式存储在一个很大的bitmap中<布隆过滤器>，一定不存在的数据会被这个bitmap拦截掉，从而避免了对底层存储系统的查询压力
- 3、从缓存取不到的数据，在数据库中也没有取到，这时也可以将key-value对写为key-null，缓存有效时间可以设置短点，如30秒（设置太长会导致正常情况也没法使用）。这样可以防止攻击用户反复用同一个id暴力攻击。


## 缓存雪崩
### 概念
缓存雪崩，是指在某一个时间段，缓存集中过期失效或Redis服务器宕机。

### 存在的问题
某一时刻同时失效，请求全部转发到DB，DB瞬时压力过重雪崩。

### 解决办法
- 1、缓存数据的过期时间设置随机，防止同一时间大量数据过期现象发生。
- 2、如果缓存数据库是分布式部署，将热点数据均匀分布在不同的缓存数据库中。
- 3、设置热点数据永远不过期。
- 4、用加分布式锁或者分布式队列的方式保证缓存的单线程（进程）写 （eg. redis的 SETNX），从而避免失效时大量的并发请求落到底层存储系统上。在加锁方法内先从缓存中再获取一次(防止另外的线程优先获取锁已经写入了缓存)，没有再查DB写入缓存。

## 缓存击穿
### 概念
缓存击穿是在高并发的条件下读取缓存数据，多用户同时请求同一个缓存数据，如某个热点key，如果缓存中没有这条数据，那么这些用户又会同时去数据库中查询这条数据，造成缓存击穿。

### 存在的问题
浪费了系统资源，有悖于缓存数据的初衷，严重的话可能会造成服务器宕机的风险。

### 解决办法
- 1、设置热点数据永远不过期。
- 2、用加锁或者队列的方式保证缓存的单线程（进程）写，在加锁方法内先从缓存中再获取一次，没有再查DB写入缓存。 
